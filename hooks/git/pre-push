#!/bin/bash
#===============================================================================
# RLM System Pre-Push Hook
#
# Prevents pushes to main/master branches unless executed by authorized agents
# (devops or orchestrator).
#
# Installation:
#   cp hooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push
#
# Or use the install-hooks.sh script.
#
# How it works:
#   - Checks if pushing to main or master branch
#   - If so, requires RLM_AGENT environment variable to be set to
#     'devops' or 'orchestrator'
#   - Blocks push with helpful error message if unauthorized
#
# For manual overrides (human developers), set:
#   RLM_AGENT=human git push origin main
#===============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Protected branches
PROTECTED_BRANCHES="main master"

# Authorized agents that can push to protected branches
AUTHORIZED_AGENTS="devops orchestrator human"

# Read stdin for push information
# Format: <local ref> <local sha> <remote ref> <remote sha>
while read local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from remote ref
    # e.g., refs/heads/main -> main
    if [[ "$remote_ref" =~ refs/heads/(.+)$ ]]; then
        branch="${BASH_REMATCH[1]}"
    else
        continue
    fi

    # Check if pushing to a protected branch
    for protected in $PROTECTED_BRANCHES; do
        if [[ "$branch" == "$protected" ]]; then
            # Get current agent from environment variable
            current_agent="${RLM_AGENT:-unknown}"

            # Check if agent is authorized
            is_authorized=false
            for authorized in $AUTHORIZED_AGENTS; do
                if [[ "$current_agent" == "$authorized" ]]; then
                    is_authorized=true
                    break
                fi
            done

            if [[ "$is_authorized" == "false" ]]; then
                echo -e "${RED}╔═══════════════════════════════════════════════════════════════╗${NC}"
                echo -e "${RED}║                    PUSH BLOCKED                               ║${NC}"
                echo -e "${RED}╚═══════════════════════════════════════════════════════════════╝${NC}"
                echo ""
                echo -e "${YELLOW}Branch:${NC} $branch (protected)"
                echo -e "${YELLOW}Agent:${NC}  ${current_agent:-not set}"
                echo ""
                echo -e "Pushing to ${RED}$branch${NC} is restricted to authorized agents only."
                echo ""
                echo "Authorized agents: ${GREEN}devops${NC}, ${GREEN}orchestrator${NC}"
                echo ""
                echo "If you are an authorized agent, set the RLM_AGENT environment variable:"
                echo -e "  ${GREEN}export RLM_AGENT=devops${NC}"
                echo -e "  ${GREEN}export RLM_AGENT=orchestrator${NC}"
                echo ""
                echo "For human developers performing manual operations:"
                echo -e "  ${GREEN}RLM_AGENT=human git push origin $branch${NC}"
                echo ""
                echo -e "${YELLOW}Recommended workflow:${NC}"
                echo "  1. Create a feature branch: git checkout -b feature/my-change"
                echo "  2. Make your changes and commit"
                echo "  3. Push feature branch: git push -u origin feature/my-change"
                echo "  4. Create a pull request for review"
                echo "  5. Let devops/orchestrator agent merge after approval"
                echo ""
                exit 1
            else
                echo -e "${GREEN}✓${NC} Push to $branch authorized (agent: $current_agent)"
            fi
        fi
    done
done

exit 0
